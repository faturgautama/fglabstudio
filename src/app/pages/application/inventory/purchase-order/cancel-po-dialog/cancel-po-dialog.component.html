<p-dialog [(visible)]="visible" [style]="{ width: '60rem', maxHeight: '90vh' }" header="Batalkan Purchase Order"
    [modal]="true" [draggable]="false" [resizable]="false" appendTo="body" (onHide)="onClose()">

    <div class="flex flex-col gap-4">
        <!-- PO Info -->
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="grid grid-cols-4 gap-4 text-sm">
                <div>
                    <p class="text-gray-600">Nomor PO</p>
                    <p class="font-semibold">{{ poData?.po_number }}</p>
                </div>
                <div>
                    <p class="text-gray-600">Supplier</p>
                    <p class="font-semibold">{{ poData?.supplier?.name }}</p>
                </div>
                <div>
                    <p class="text-gray-600">Gudang</p>
                    <p class="font-semibold">ðŸ“¦ {{ poData?.warehouse?.name || 'N/A' }}</p>
                    @if (poData?.warehouse?.code) {
                    <p class="text-xs text-gray-500">{{ poData?.warehouse?.code }}</p>
                    }
                </div>
                <div>
                    <p class="text-gray-600">Tanggal Order</p>
                    <p class="font-semibold">{{ poData?.order_date | date:'dd/MM/yyyy' }}</p>
                </div>
            </div>
        </div>

        <!-- Warning if items already received -->
        @if (hasReceivedItems()) {
        <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg">
            <div class="flex items-start gap-3">
                <i class="pi pi-exclamation-triangle text-orange-600 text-xl mt-0.5"></i>
                <div class="flex flex-col gap-2">
                    <p class="text-sm font-semibold text-orange-800">Peringatan!</p>
                    <p class="text-sm text-orange-700">
                        Purchase Order ini sudah memiliki barang yang diterima ({{ getTotalQtyReceived() }} dari {{
                        getTotalQtyOrdered() }} item).
                        Membatalkan PO akan mengembalikan stok yang sudah diterima.
                    </p>
                </div>
            </div>
        </div>
        }

        <!-- Items Summary -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 text-left">Produk</th>
                        <th class="p-3 text-center w-32">Qty Dipesan</th>
                        <th class="p-3 text-center w-32">Qty Diterima</th>
                        <th class="p-3 text-center w-32">Status</th>
                    </tr>
                </thead>
                <tbody>
                    @for (item of poData?.items; track item.id) {
                    <tr class="border-b">
                        <td class="p-3">
                            <div class="flex flex-col gap-1">
                                <p class="font-medium">{{ item.product?.name }}</p>
                                <p class="text-xs text-gray-500">SKU: {{ item.product?.sku }}</p>
                            </div>
                        </td>
                        <td class="p-3 text-center">
                            <span class="font-semibold">{{ item.qty_ordered }}</span>
                        </td>
                        <td class="p-3 text-center">
                            <span [class]="item.qty_received > 0 ? 'text-green-600 font-semibold' : 'text-gray-400'">
                                {{ item.qty_received }}
                            </span>
                        </td>
                        <td class="p-3 text-center">
                            @if (item.qty_received === 0) {
                            <span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">
                                Belum Diterima
                            </span>
                            } @else if (item.qty_received < item.qty_ordered) { <span
                                class="px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded">
                                Sebagian Diterima
                                </span>
                                } @else {
                                <span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded">
                                    Lengkap
                                </span>
                                }
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Cancel Reason -->
        <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold text-gray-700">
                Alasan Pembatalan <span class="text-red-500">*</span>
            </label>
            <textarea pInputTextarea [(ngModel)]="cancelReason"
                placeholder="Masukkan alasan pembatalan (minimal 10 karakter)" rows="4" class="w-full"
                [class.border-red-500]="validationError">
            </textarea>
            @if (validationError) {
            <small class="text-red-500">{{ validationError }}</small>
            }
            <small class="text-gray-500">
                {{ cancelReason.length }} karakter (minimal 10 karakter)
            </small>
        </div>

        <!-- Confirmation Message -->
        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex items-start gap-3">
                <i class="pi pi-info-circle text-red-600 text-xl mt-0.5"></i>
                <div class="flex flex-col gap-1">
                    <p class="text-sm font-semibold text-red-800">Konfirmasi Pembatalan</p>
                    <p class="text-sm text-red-700">
                        Dengan membatalkan Purchase Order ini:
                    </p>
                    <ul class="list-disc list-inside text-sm text-red-700 ml-2">
                        <li>Status PO akan diubah menjadi "Dibatalkan"</li>
                        @if (hasReceivedItems()) {
                        <li>Stok yang sudah diterima akan dikembalikan ({{ getTotalQtyReceived() }} item)</li>
                        <li>Batch yang terkait akan dinonaktifkan</li>
                        <li>Serial number akan diubah statusnya</li>
                        <li>Stock card OUT akan dibuat untuk pencatatan</li>
                        }
                        <li>PO tidak dapat diaktifkan kembali setelah dibatalkan</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="flex justify-end gap-3 mt-4 pt-4 border-t">
        <p-button label="Batal" severity="secondary" (onClick)="onClose()">
        </p-button>
        <p-button label="Batalkan PO" severity="danger" icon="pi pi-times" [disabled]="!canCancel()"
            (onClick)="onCancel()">
        </p-button>
    </div>
</p-dialog>