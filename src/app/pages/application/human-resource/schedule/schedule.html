<app-dsh-base-layout>
    <p-toast></p-toast>

    <div class="time-off-container rounded-lg p-3">
        <!-- Department Tabs -->
        <div class="department-tabs">
            @for (dept of departments(); track dept.id) {
            <button class="tab-button" [class.active]="selectedDepartmentId() === dept.id"
                (click)="onDepartmentChange(dept.id)">
                {{ dept.title }}
            </button>
            }
        </div>

        <!-- Main Content -->
        <div class="time-off-content">
            <!-- Left Sidebar: Employee List -->
            <div class="employee-sidebar">
                <!-- Search with PrimeNG -->
                <div class="search-box">
                    <p-iconfield>
                        <p-inputicon class="pi pi-search" />
                        <input type="text" pInputText placeholder="Search employee.." [value]="searchQuery()"
                            (input)="onSearch($any($event.target).value)" class="w-full">
                    </p-iconfield>
                </div>

                <!-- Employee List -->
                <div class="employee-list">
                    @for (employee of filteredEmployees(); track employee.id) {
                    <div class="employee-item">
                        <div class="employee-info">
                            <p class="employee-name">{{ employee.full_name }}</p>
                            <p class="employee-position">{{ employee.position?.title || 'No Position' }}</p>
                        </div>
                    </div>
                    }

                    @if (filteredEmployees().length === 0) {
                    <div class="empty-state">
                        <i class="pi pi-users" style="font-size: 2rem; color: #cbd5e1;"></i>
                        <p>No employees found</p>
                    </div>
                    }
                </div>
            </div>

            <!-- Right: Timeline Calendar -->
            <div class="timeline-calendar">
                <!-- Calendar Navigation -->
                <div class="calendar-nav">
                    <p-button icon="pi pi-chevron-left" severity="secondary" (onClick)="previousMonth()"
                        styleClass="p-button-text p-button-sm">
                    </p-button>
                    <span class="current-month">
                        {{ currentDate() | date: 'MMMM yyyy' }}
                    </span>
                    <p-button label="Today" severity="secondary" (onClick)="goToToday()" styleClass="p-button-sm">
                    </p-button>
                    <p-button icon="pi pi-chevron-right" severity="secondary" (onClick)="nextMonth()"
                        styleClass="p-button-text p-button-sm">
                    </p-button>
                </div>

                <!-- Calendar Header (Days) -->
                <div class="calendar-header">
                    @for (day of visibleDays(); track $index) {
                    <div class="calendar-day-header" [class.today]="day.isToday" [class.weekend]="day.isWeekend">

                        <!-- Month separator -->
                        @if ($index === 0 || day.dayNumber === 1) {
                        <div class="month-label">{{ day.month }}</div>
                        }

                        <!-- Day number -->
                        <div class="day-number">{{ day.dayNumber }}</div>

                        <!-- Today marker -->
                        @if (day.isToday) {
                        <div class="today-badge">Today</div>
                        }
                    </div>
                    }
                </div>

                <!-- Calendar Body (Timeline Rows) -->
                <div class="calendar-body">
                    @for (employee of filteredEmployees(); track employee.id; let rowIndex = $index) {
                    <div class="timeline-row">
                        <!-- Day cells background -->
                        @for (day of visibleDays(); track $index) {
                        <div class="day-cell" [class.today]="day.isToday" [class.weekend]="day.isWeekend">
                        </div>
                        }

                        <!-- Time-off entries overlay -->
                        <div class="entries-overlay">
                            @for (position of timeOffPositions(); track position.entry.id) {
                            @if (position.rowIndex === rowIndex) {
                            <div class="leave-entry" [ngClass]="getLeaveTypeClass(position.entry.leave_policy_id)"
                                [style.left.%]="position.left" [style.width.%]="position.width"
                                [pTooltip]="getLeaveTooltip(position.entry)" tooltipPosition="top" [escape]="false">
                                <span class="leave-label">
                                    {{ getLeaveTypeName(position.entry.leave_policy_id) }} ({{ position.entry.total_days
                                    }}d)
                                </span>
                            </div>
                            }
                            }
                        </div>
                    </div>
                    }

                    @if (filteredEmployees().length === 0) {
                    <div class="empty-calendar-state">
                        <i class="pi pi-calendar" style="font-size: 3rem; color: #cbd5e1;"></i>
                        <p>No employees to display</p>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
</app-dsh-base-layout>